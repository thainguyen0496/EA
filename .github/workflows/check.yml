name: MQL5-Compile-Final
on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MQL5 Compiler
        shell: powershell
        run: |
          # Tải file metaeditor64.exe từ kho lưu trữ tin cậy (phiên bản Portable)
          # Link này được duy trì bởi cộng đồng chuyên làm Action cho MQL5
          $url = "https://github.com/mql-actions/mql-compiler/raw/main/bin/metaeditor64.exe"
          Invoke-WebRequest -Uri $url -OutFile "metaeditor64.exe"
          
          # Tạo môi trường giả lập để compiler không báo lỗi
          New-Item -ItemType Directory -Force -Path "MQL5/Experts"

      - name: Compile EA
        shell: powershell
        run: |
          # Chạy biên dịch
          # /inc: . nghĩa là tìm các file thư viện ngay tại thư mục hiện tại
          ./metaeditor64.exe /compile:"Experts/MyEA.mq5" /log:"compile.log" /inc:"."
          
          # Đợi 1 giây để ghi log
          Start-Sleep -s 1

          # Hiển thị log lỗi ra màn hình để bạn xem
          if (Test-Path "compile.log") {
              $logContent = Get-Content "compile.log" -Encoding Unicode
              Write-Host "--- NHAT KY BIEN DICH ---"
              $logContent
          }

          # Kiểm tra file kết quả
          if (Test-Path "Experts/MyEA.ex5") {
              Write-Host "✅ THANH CONG! Code ban da chuan."
          } else {
              Write-Host "❌ LOI ROI! Hay doc nhat ky ben tren de biet sai o dau."
              exit 1
          }
